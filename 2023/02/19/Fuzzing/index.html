

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/MyPic/bella.png">
  <link rel="icon" href="/MyPic/bella.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="kawa_von">
  <meta name="keywords" content="">
  
    <meta name="description" content="初探Fuzz安装官网下载https:&#x2F;&#x2F;lcamtuf.coredump.cx&#x2F;afl&#x2F;然后安装tar zxvf afl-2.52b.tgzmakesudo make install安装结束 初步使用AFL样例程序（靶） 1234567891011121314151617181920212223242526272829303132333435#include &lt;stdio.h&gt; #in">
<meta property="og:type" content="article">
<meta property="og:title" content="Fuzzing">
<meta property="og:url" content="http://example.com/2023/02/19/Fuzzing/index.html">
<meta property="og:site_name" content="FCさん の Blog">
<meta property="og:description" content="初探Fuzz安装官网下载https:&#x2F;&#x2F;lcamtuf.coredump.cx&#x2F;afl&#x2F;然后安装tar zxvf afl-2.52b.tgzmakesudo make install安装结束 初步使用AFL样例程序（靶） 1234567891011121314151617181920212223242526272829303132333435#include &lt;stdio.h&gt; #in">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/02/19/Fuzzing/afl_ui.png">
<meta property="article:published_time" content="2023-02-19T14:23:43.000Z">
<meta property="article:modified_time" content="2023-02-26T10:11:00.292Z">
<meta property="article:author" content="kawa_von">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/02/19/Fuzzing/afl_ui.png">
  
  
  <title>Fuzzing - FCさん の Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>kawasuki</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/MyPic/asoul2.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Fuzzing">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-02-19 22:23" pubdate>
        2023年2月19日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      32k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      263 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Fuzzing</h1>
            
            <div class="markdown-body">
              <h1 id="初探Fuzz"><a href="#初探Fuzz" class="headerlink" title="初探Fuzz"></a>初探Fuzz</h1><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>官网下载<br><a target="_blank" rel="noopener" href="https://lcamtuf.coredump.cx/afl/">https://lcamtuf.coredump.cx/afl/</a><br>然后安装<br><code>tar zxvf afl-2.52b.tgz</code><br><code>make</code><br><code>sudo make install</code><br>安装结束</p>
<h3 id="初步使用AFL"><a href="#初步使用AFL" class="headerlink" title="初步使用AFL"></a>初步使用AFL</h3><p>样例程序（靶）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span> </span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">vuln</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(str);<br>    <span class="hljs-keyword">if</span>(str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp; len == <span class="hljs-number">66</span>)<br>    &#123;<br>        <span class="hljs-built_in">raise</span>(SIGSEGV);<br>        <span class="hljs-comment">//如果输入的字符串的首字符为A并且长度为66，则异常退出</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(str[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;F&#x27;</span> &amp;&amp; len == <span class="hljs-number">6</span>)<br>    &#123;<br>        <span class="hljs-built_in">raise</span>(SIGSEGV);<br>        <span class="hljs-comment">//如果输入的字符串的首字符为F并且长度为6，则异常退出</span><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;it is good!\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">gets</span>(buf);<span class="hljs-comment">//存在栈溢出漏洞</span><br>    <span class="hljs-built_in">printf</span>(buf);<span class="hljs-comment">//存在格式化字符串漏洞</span><br>    <span class="hljs-built_in">vuln</span>(buf);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="编译程序"><a href="#编译程序" class="headerlink" title="编译程序"></a>编译程序</h3><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">afl-gcc -g -o afl_test afl_test.<span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure>

<h3 id="建立读入、输出文件夹"><a href="#建立读入、输出文件夹" class="headerlink" title="建立读入、输出文件夹"></a>建立读入、输出文件夹</h3><p>如fuzz_in,fuzz_out</p>
<h3 id="开始fuzz"><a href="#开始fuzz" class="headerlink" title="开始fuzz"></a>开始fuzz</h3><p><code>afl-fuzz -i fuzz_in -o fuzz_out ./afl_test</code><br>接下来会报错<br><code> Pipe at the beginning of &#39;core_pattern&#39;</code><br>进行设置<br><code>sudo su</code><br><code> echo core &gt;/proc/sys/kernel/core_pattern</code><br>再次执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">afl-fuzz -i fuzz_in -o fuzz_out ./afl_test<br></code></pre></td></tr></table></figure>
<p>即可进入AFL仪表盘</p>
<h3 id="AFL-仪表盘"><a href="#AFL-仪表盘" class="headerlink" title="AFL 仪表盘"></a>AFL 仪表盘</h3><p><img src="/2023/02/19/Fuzzing/afl_ui.png" srcset="/img/loading.gif" lazyload alt="AFL仪表盘"></p>
<p>关注<br><code>stage progress </code><br>若exec speed 低于600，则速度太慢<br><code> unique crashes</code><br>发现的路径数</p>
<h3 id="分析结果"><a href="#分析结果" class="headerlink" title="分析结果"></a>分析结果</h3><p><code> Ctrl+C</code><br>结束运行<br>进入fuzz_out<br>输入<code>xxd id:.........</code><br>查看结果，并分析</p>
<h1 id="AFL源码分析"><a href="#AFL源码分析" class="headerlink" title="AFL源码分析"></a>AFL源码分析</h1><h2 id="afl-gcc-c"><a href="#afl-gcc-c" class="headerlink" title="afl-gcc.c"></a>afl-gcc.c</h2><p><strong>afl-gcc.c</strong>是封装（wrapper）了gcc的一个文件<br>afl-gcc会寻找、配置环境变量以及许多配置数据。<br><strong>变量：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u8*  as_path;                <span class="hljs-comment">/* Path to the AFL &#x27;as&#x27; wrapper      */</span> as的路径，接下来的函数find_as就是为了确定这个参数<br><span class="hljs-type">static</span> u8** cc_params;              <span class="hljs-comment">/* Parameters passed to the real CC  */</span><br><span class="hljs-type">static</span> u32  cc_par_cnt = <span class="hljs-number">1</span>;         <span class="hljs-comment">/* Param count, including argv0      */</span><br><span class="hljs-type">static</span> u8   be_quiet,               <span class="hljs-comment">/* Quiet mode                        */</span><br>            clang_mode;             <span class="hljs-comment">/* Invoked as afl-clang*?            */</span><br>            <br></code></pre></td></tr></table></figure>

<p><strong>函数  find_as(u8* argv0):</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">find_as</span><span class="hljs-params">(u8* argv0)</span> &#123;<br><br>  u8 *afl_path = getenv(<span class="hljs-string">&quot;AFL_PATH&quot;</span>); <span class="hljs-comment">//getenv()函数，直接寻找环境变量中有无目标值，有就以字符串+null形式返回，无则直接返回null</span><br>  u8 *slash, *tmp;<span class="hljs-comment">// slash 斜杠 “\”  </span><br><br>  <span class="hljs-keyword">if</span> (afl_path) &#123;<br><br>    tmp = alloc_printf(<span class="hljs-string">&quot;%s/as&quot;</span>, afl_path);<span class="hljs-comment">//将找到的路径与/as拼接，尝试找到目标程序</span><br><br>    <span class="hljs-keyword">if</span> (!access(tmp, X_OK)) &#123; <span class="hljs-comment">// access()函数会尝试运行目标程序，成功返回值为0，否则返回-1，本句意为若通过环境变量找到了as，就...</span><br>      as_path = afl_path;<br>      ck_free(tmp);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ck_free(tmp);<br><br>  &#125;<br><br>  slash = <span class="hljs-built_in">strrchr</span>(argv0, <span class="hljs-string">&#x27;/&#x27;</span>);<span class="hljs-comment">//找到最后一次出现字符&#x27;/&#x27;的位置并返回之</span><br><br>  <span class="hljs-keyword">if</span> (slash) &#123;<span class="hljs-comment">//若找到&#x27;/&#x27;</span><br><br>    u8 *dir;<br><br>    *slash = <span class="hljs-number">0</span>;<br>    dir = ck_strdup(argv0);<span class="hljs-comment">//argv0是int main(int argc, char**argv)的第一个参数</span><br>    *slash = <span class="hljs-string">&#x27;/&#x27;</span>;<br><br>    tmp = alloc_printf(<span class="hljs-string">&quot;%s/afl-as&quot;</span>, dir);<span class="hljs-comment">//拼接运行时给入的地址与as</span><br><br>    <span class="hljs-keyword">if</span> (!access(tmp, X_OK)) &#123;<br>      as_path = dir;<br>      ck_free(tmp);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ck_free(tmp);<br>    ck_free(dir);<br><br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!access(AFL_PATH <span class="hljs-string">&quot;/as&quot;</span>, X_OK)) &#123;<br>    as_path = AFL_PATH;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  FATAL(<span class="hljs-string">&quot;Unable to find AFL wrapper binary for &#x27;as&#x27;. Please set AFL_PATH&quot;</span>);<span class="hljs-comment">//若找不到as，抛出错误</span><br> <br>&#125;<br></code></pre></td></tr></table></figure>

<p>即本函数是寻找assembler的过程，没找到就报错</p>
<p><strong>函数edit_params</strong></p>
<ul>
<li>该函数将arvg[0]中的最后’&#39;后的字符串赋给name，根据一系列判断，确定’afl-lang’ or ‘afl-lang++’ or 其他平台，如APPLE等。</li>
<li>即读取第一个参数，然后确定平台、方式</li>
<li>随后进入while循环，读取argv[1]开始的参数</li>
<li>若为’-B’，提示<code>&quot;-B is already set, overriding&quot;</code></li>
<li>若为’-integrated-as’，略过</li>
<li>等等</li>
</ul>
<p><strong>离开while循环后</strong><br>若为<code>clang_mode</code>，设置<code>cc_params[cc_par_cnt++] = &#39;-no-integranted-as&#39;;</code><br>如果存在环境变量 <code>AFL_HARDEN</code>，则设置<code>-fstack-protector-all</code>。且如果没有设置<code> fortify_set</code> ，追加<code>-D_FORTIFY_SOURCE=2</code></p>
<p>之后还要一系列参数设置<br>总而言之，该函数是为了将参数设置好，符合运行环境以及指令。</p>
<p><strong>main函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> &#123;<br><br>  <span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">2</span>) &amp;&amp; !getenv(<span class="hljs-string">&quot;AFL_QUIET&quot;</span>)) &#123;<br><br>    SAYF(cCYA <span class="hljs-string">&quot;afl-cc &quot;</span> cBRI VERSION cRST <span class="hljs-string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);<br><br>  &#125; <span class="hljs-keyword">else</span> be_quiet = <span class="hljs-number">1</span>;<br><br>  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>) &#123;<br><br>    SAYF(<span class="hljs-string">&quot;\n&quot;</span><br>         <span class="hljs-string">&quot;This is a helper application for afl-fuzz. It serves as a drop-in replacement\n&quot;</span><br>         <span class="hljs-string">&quot;for gcc or clang, letting you recompile third-party code with the required\n&quot;</span><br>         <span class="hljs-string">&quot;runtime instrumentation. A common use pattern would be one of the following:\n\n&quot;</span><br><br>         <span class="hljs-string">&quot;  CC=%s/afl-gcc ./configure\n&quot;</span><br>         <span class="hljs-string">&quot;  CXX=%s/afl-g++ ./configure\n\n&quot;</span><br><br>         <span class="hljs-string">&quot;You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n&quot;</span><br>         <span class="hljs-string">&quot;Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n&quot;</span>,<br>         BIN_PATH, BIN_PATH);<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br><br>  &#125;<br><br>  find_as(argv[<span class="hljs-number">0</span>]);<br><br>  edit_params(argc, argv);<br><br>  execvp(cc_params[<span class="hljs-number">0</span>], (<span class="hljs-type">char</span>**)cc_params);<span class="hljs-comment">//调用以上两个函数，完成配置</span><br><br>  FATAL(<span class="hljs-string">&quot;Oops, failed to execute &#x27;%s&#x27; - check your PATH&quot;</span>, cc_params[<span class="hljs-number">0</span>]);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="afl-as-c"><a href="#afl-as-c" class="headerlink" title="afl-as.c"></a>afl-as.c</h2><p><strong>参数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u8** as_params;          <span class="hljs-comment">/* Parameters passed to the real &#x27;as&#x27;   */</span> <span class="hljs-comment">// 传给as的参数</span><br><br><span class="hljs-type">static</span> u8*  input_file;         <span class="hljs-comment">/* Originally specified input file      */</span><br><span class="hljs-type">static</span> u8*  modified_file;      <span class="hljs-comment">/* Instrumented file for the real &#x27;as&#x27;  */</span> <span class="hljs-comment">//as进行插桩的文件</span><br><br><span class="hljs-type">static</span> u8   be_quiet,           <span class="hljs-comment">/* Quiet mode (no stderr output)        */</span><br>            clang_mode,         <span class="hljs-comment">/* Running in clang mode?               */</span><br>            pass_thru,          <span class="hljs-comment">/* Just pass data through?              */</span><br>            just_version,       <span class="hljs-comment">/* Just show version?                   */</span><br>            sanitizer;          <span class="hljs-comment">/* Using ASAN / MSAN                    */</span><br><br><span class="hljs-type">static</span> u32  inst_ratio = <span class="hljs-number">100</span>,   <span class="hljs-comment">/* Instrumentation probability (%)      */</span>  <span class="hljs-comment">// 插桩覆盖率</span><br>            as_par_cnt = <span class="hljs-number">1</span>;     <span class="hljs-comment">/* Number of params to &#x27;as&#x27;             */</span><br></code></pre></td></tr></table></figure>

<p><strong>函数edit_params</strong><br>同afl-gcc中一致，进行参数配置</p>
<p><strong>函数add_instrumentation</strong><br>插桩函数，此函数负责处理输入文件，生成<code>modified_file</code>，将instrumentations插入所有适当位置。</p>
<ul>
<li><p>读取input-file</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (input_file) &#123;<br><br>    inf = fopen(input_file, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!inf) PFATAL(<span class="hljs-string">&quot;Unable to read &#x27;%s&#x27;&quot;</span>, input_file);<br><br>  &#125; <span class="hljs-keyword">else</span> inf = <span class="hljs-built_in">stdin</span>;<br>  <span class="hljs-comment">//若打开失败，报错无法读取，或直接从stdin读取</span><br></code></pre></td></tr></table></figure></li>
<li><p>写入modified-file</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">outfd = open(modified_file, O_WRONLY | O_EXCL | O_CREAT, <span class="hljs-number">0600</span>);<br><br><span class="hljs-keyword">if</span> (outfd &lt; <span class="hljs-number">0</span>) PFATAL(<span class="hljs-string">&quot;Unable to write to &#x27;%s&#x27;&quot;</span>, modified_file);<br><br>outf = fdopen(outfd, <span class="hljs-string">&quot;w&quot;</span>);<br><br><span class="hljs-keyword">if</span> (!outf) PFATAL(<span class="hljs-string">&quot;fdopen() failed&quot;</span>); <br></code></pre></td></tr></table></figure>
<p>接下来看看下一段</p>
</li>
</ul>
<p><strong>真正有趣的地方，插桩逻辑开始之处</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* All right, this is where the actual fun begins. For one, we only want to</span><br><span class="hljs-comment">       instrument the .text section. So, let&#x27;s keep track of that in processed</span><br><span class="hljs-comment">       files - and let&#x27;s set instr_ok accordingly. */</span><br><br>    <span class="hljs-keyword">if</span> (line[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\t&#x27;</span> &amp;&amp; line[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br><br>      <span class="hljs-comment">/* OpenBSD puts jump tables directly inline with the code, which is</span><br><span class="hljs-comment">         a bit annoying. They use a specific format of p2align directives</span><br><span class="hljs-comment">         around them, so we use that as a signal. */</span><br><br>      <span class="hljs-keyword">if</span> (!clang_mode &amp;&amp; instr_ok &amp;&amp; !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;p2align &quot;</span>, <span class="hljs-number">8</span>) &amp;&amp;<br>          <span class="hljs-built_in">isdigit</span>(line[<span class="hljs-number">10</span>]) &amp;&amp; line[<span class="hljs-number">11</span>] == <span class="hljs-string">&#x27;\n&#x27;</span>) skip_next_label = <span class="hljs-number">1</span>;<br><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;text\n&quot;</span>, <span class="hljs-number">5</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;section\t.text&quot;</span>, <span class="hljs-number">13</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;section\t__TEXT,__text&quot;</span>, <span class="hljs-number">21</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;section __TEXT,__text&quot;</span>, <span class="hljs-number">21</span>)) &#123;<br>        instr_ok = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">continue</span>; <br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;section\t&quot;</span>, <span class="hljs-number">8</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;section &quot;</span>, <span class="hljs-number">8</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;bss\n&quot;</span>, <span class="hljs-number">4</span>) ||<br>          !<span class="hljs-built_in">strncmp</span>(line + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;data\n&quot;</span>, <span class="hljs-number">5</span>)) &#123;<br>        instr_ok = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>由于插桩只向<code>.text</code>部分插入，故需要进行该部分的匹配（确认是否在此部分中）</li>
<li>即匹配<code>text   section\t.text </code>等四个str，若匹配成功，<code>continue</code>跳出，进行下一次循环</li>
<li>若匹配失败，再与非.text字段进行匹配，若匹配成功，证明不在.text段内，也<code>continue</code>跳出</li>
<li>上述两种情况，参数<code>instr_ok</code>分别为1、0，即代表是否位于理想字段内。</li>
</ul>
<p>后续进行三个判定，来确认一些参数的值。</p>
<ul>
<li>插桩时关注的重点是<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">^main:      - function entry point (always <span class="hljs-keyword">instrumented)</span><br><span class="hljs-keyword"></span>         ^.L0:       - GCC <span class="hljs-keyword">branch </span>label<br>         ^.<span class="hljs-keyword">LBB0_0: </span>  - clang <span class="hljs-keyword">branch </span>label (<span class="hljs-keyword">but </span>only in clang mode)<br>         ^\tjnz foo  - conditional <span class="hljs-keyword">branches</span><br></code></pre></td></tr></table></figure>
故检测形如<code>\tj[^m]</code>的格式的命令，即为条件跳转命令。当随机数小于覆盖率时，会将<code>trampoline_fmt_64</code>写入<code>R(MAP_SIZE)</code>位进入文件，随后插桩计数<code>ins_lines</code>加一，continue跳出。<br>对于clang，APPLE是相似的过程，即适用于不同编译系统</li>
</ul>
<p>最后回到while循环的开始处<br>从刚刚就一直困扰我的问题——判断条件合适（位于.text中），却跳转进下一个循环是为什么，得到了解决。<br>可以看到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;<br>        instrument_next &amp;&amp; line[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\t&#x27;</span> &amp;&amp; <span class="hljs-built_in">isalpha</span>(line[<span class="hljs-number">1</span>])) &#123;<br><br>      <span class="hljs-built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,<br>              R(MAP_SIZE));<br><br>      instrument_next = <span class="hljs-number">0</span>;<br>      ins_lines++;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>循环开始时便进行了一次条件检测，当合适时，进行插桩，再重新布置参数，使得不漏一处。</p>
<p><strong>至此，插桩的逻辑基本完成。</strong><br><strong>总结：插桩是通过遍历目标文件行，寻找敏感处并进行标记，于本次循环或下次循环进行插桩，然后再去寻找下处可插处，直至lines遍历完毕</strong></p>
<h2 id="afl-as-h"><a href="#afl-as-h" class="headerlink" title="afl-as.h"></a>afl-as.h</h2><p>上面读了两个文件中描述了插桩过程的逻辑，其中真正的插桩，<code>trampoline_fmt_64/32</code>是关键所在（插入了什么内容？）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs trampoline_fmt_64/32```定义于```afl-as.h```中，以下是其代码">```c<br>static const u8* trampoline_fmt_32 =<br><br>  &quot;\n&quot;<br>  &quot;/* --- AFL TRAMPOLINE (32-BIT) --- */\n&quot;<br>  &quot;\n&quot;<br>  &quot;.align 4\n&quot;<br>  &quot;\n&quot;<br>  &quot;leal -16(%%esp), %%esp\n&quot;<br>  &quot;movl %%edi,  0(%%esp)\n&quot;<br>  &quot;movl %%edx,  4(%%esp)\n&quot;<br>  &quot;movl %%ecx,  8(%%esp)\n&quot;<br>  &quot;movl %%eax, 12(%%esp)\n&quot;<br>  &quot;movl $0x%08x, %%ecx\n&quot;<br>  &quot;call __afl_maybe_log\n&quot;<br>  &quot;movl 12(%%esp), %%eax\n&quot;<br>  &quot;movl  8(%%esp), %%ecx\n&quot;<br>  &quot;movl  4(%%esp), %%edx\n&quot;<br>  &quot;movl  0(%%esp), %%edi\n&quot;<br>  &quot;leal 16(%%esp), %%esp\n&quot;<br>  &quot;\n&quot;<br>  &quot;/* --- END --- */\n&quot;<br>  &quot;\n&quot;;<br><br>static const u8* trampoline_fmt_64 =<br><br>  &quot;\n&quot;<br>  &quot;/* --- AFL TRAMPOLINE (64-BIT) --- */\n&quot;<br>  &quot;\n&quot;<br>  &quot;.align 4\n&quot;<br>  &quot;\n&quot;<br>  &quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;<br>  &quot;movq %%rdx,  0(%%rsp)\n&quot; <br>  &quot;movq %%rcx,  8(%%rsp)\n&quot;<br>  &quot;movq %%rax, 16(%%rsp)\n&quot; // save rdx rcx rax <br>  &quot;movq $0x%08x, %%rcx\n&quot; // set what will be print by fprintf() in rcx<br>  &quot;call __afl_maybe_log\n&quot;<br>  &quot;movq 16(%%rsp), %%rax\n&quot;<br>  &quot;movq  8(%%rsp), %%rcx\n&quot;<br>  &quot;movq  0(%%rsp), %%rdx\n&quot; // 恢复寄存器<br>  &quot;leaq (128+24)(%%rsp), %%rsp\n&quot;<br>  &quot;\n&quot;<br>  &quot;/* --- END --- */\n&quot;<br>  &quot;\n&quot;;<br></code></pre></td></tr></table></figure>
<p>其中，真正的核心是<code>call __afl_maybe_log</code><br>这个指令来自<code>main_payload_64/32</code><br><strong>__afl_maybe_log</strong><br>其中<code>__afl_maybe_log</code>定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-string">&quot;__afl_maybe_log:\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  lahf\n&quot;</span><br>  <span class="hljs-string">&quot;  seto  %al\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Check if SHM region is already mapped. */\n&quot;</span><span class="hljs-comment">//检查共享内存是否进行了设置</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq  __afl_area_ptr(%rip), %rdx\n&quot;</span><br>  <span class="hljs-string">&quot;  testq %rdx, %rdx\n&quot;</span> <span class="hljs-comment">// 判断__afl_area_ptr是否为null</span><br>  <span class="hljs-string">&quot;  je    __afl_setup\n&quot;</span> <span class="hljs-comment">// 为空则跳转</span><br></code></pre></td></tr></table></figure>
<p>使用<code>lahf</code>指令，加载状态标志位到<code>AH</code>，即<code>EFLAG</code>寄存器低八位复制到<code>AH</code>中，被复制的标志位包括：符号标志位（SF）、零标志位（ZF）、辅助进位标志位（AF）、奇偶标志位（PF）和进位标志位（CF），使用该指令可以方便地将标志位副本保存在变量中；<br>然后，使用<code>seto %al</code>溢出置位，即<strong>“如果溢出，则%al设置为1”</strong></p>
<p><strong>__afl_setup</strong><br>用于初始化<code>__afl_area_ptr</code>，且只在运行到第一个桩时进行本次初始化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-string">&quot;__afl_setup:\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Do not retry setup if we had previous failures. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  cmpb $0, __afl_setup_failure(%rip)\n&quot;</span><br>  <span class="hljs-string">&quot;  jne __afl_return\n&quot;</span><span class="hljs-comment">//先检查是否为0，不是则直接返回，“防止预先可预见的失败”</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Check out if we have a global pointer on file. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq  __afl_global_area_ptr(%rip), %rdx\n&quot;</span><br>  <span class="hljs-string">&quot;  testq %rdx, %rdx\n&quot;</span><br>  <span class="hljs-string">&quot;  je    __afl_setup_first\n&quot;</span> <span class="hljs-comment">// 如果global pointer也为空，进行初次建立</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rdx, __afl_area_ptr(%rip)\n&quot;</span><span class="hljs-comment">//否则直接赋值给area ptr，然后进入store</span><br>  <span class="hljs-string">&quot;  jmp  __afl_store\n&quot;</span> <br></code></pre></td></tr></table></figure>

<p><strong>__afl-setup_first</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-string">&quot;__afl_setup_first:\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Save everything that is not yet saved and that may be touched by\n&quot;</span><br>  <span class="hljs-string">&quot;     getenv() and several other libcalls we&#x27;ll be relying on. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  leaq -352(%rsp), %rsp\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rax,   0(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rcx,   8(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rdi,  16(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rsi,  32(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %r8,   40(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %r9,   48(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %r10,  56(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %r11,  64(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm0,  96(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm1,  112(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm2,  128(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm3,  144(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm4,  160(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm5,  176(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm6,  192(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm7,  208(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm8,  224(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm9,  240(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm10, 256(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm11, 272(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm12, 288(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm13, 304(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm14, 320(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %xmm15, 336(%rsp)\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* The 64-bit ABI requires 16-byte stack alignment. We&#x27;ll keep the\n&quot;</span><br>  <span class="hljs-string">&quot;     original stack ptr in the callee-saved r12. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  pushq %r12\n&quot;</span><br>  <span class="hljs-string">&quot;  movq  %rsp, %r12\n&quot;</span><br>  <span class="hljs-string">&quot;  subq  $16, %rsp\n&quot;</span><br>  <span class="hljs-string">&quot;  andq  $0xfffffffffffffff0, %rsp\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  leaq .AFL_SHM_ENV(%rip), %rdi\n&quot;</span><br>  CALL_L64(<span class="hljs-string">&quot;getenv&quot;</span>)<br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  testq %rax, %rax\n&quot;</span><br>  <span class="hljs-string">&quot;  je    __afl_setup_abort\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq  %rax, %rdi\n&quot;</span><br>  CALL_L64(<span class="hljs-string">&quot;atoi&quot;</span>)<br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  xorq %rdx, %rdx   /* shmat flags    */\n&quot;</span><br>  <span class="hljs-string">&quot;  xorq %rsi, %rsi   /* requested addr */\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rax, %rdi   /* SHM ID         */\n&quot;</span><br>  CALL_L64(<span class="hljs-string">&quot;shmat&quot;</span>)<br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  cmpq $-1, %rax\n&quot;</span><br>  <span class="hljs-string">&quot;  je   __afl_setup_abort\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  /* Store the address of the SHM region. */\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rax, %rdx\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rax, __afl_area_ptr(%rip)\n&quot;</span><br>  <span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __APPLE__</span><br>  <span class="hljs-string">&quot;  movq %rax, __afl_global_area_ptr(%rip)\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-string">&quot;  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx\n&quot;</span><br>  <span class="hljs-string">&quot;  movq %rax, (%rdx)\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* ^__APPLE__ */</span></span><br>  <span class="hljs-string">&quot;  movq %rax, %rdx\n&quot;</span><br></code></pre></td></tr></table></figure>

<p>先将所有寄存器内容进行保存，然后寻找共享内存，如果找不到，就调用<code>__afl_setup_abort</code><br>成功后，调用<code>__afl_forkserver</code><br><strong>__afl_forkserver</strong><br>判断fork server是否成功启动。<br><strong>__afl_fork_wait_loop</strong></p>
<ul>
<li>从管道中等待parent的信息，读入<code>__afl_temp</code>内，成功则继续；</li>
<li>fork一个子进程，子进程执行<code>__afl_fork_resume</code>；</li>
<li>将子进程pid赋值给<code>__afl_fork_pid</code>，并写入状态管道通知父进程；</li>
<li>子进程结束后告诉fuzzer，下一轮循环开始。</li>
</ul>
<h2 id="afl-fuzz-c"><a href="#afl-fuzz-c" class="headerlink" title="afl-fuzz.c"></a>afl-fuzz.c</h2><p>该文件是afl项目的核心中的核心<br>此文件篇幅过长，选择直接从main函数入口开始看（共8k余行，main位于7706行）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">SAYF(cCYA <span class="hljs-string">&quot;afl-fuzz &quot;</span> cBRI VERSION cRST <span class="hljs-string">&quot; by &lt;lcamtuf@google.com&gt;\n&quot;</span>);<br><br>  doc_path = access(DOC_PATH, F_OK) ? <span class="hljs-string">&quot;docs&quot;</span> : DOC_PATH;<br><br>  gettimeofday(&amp;tv, &amp;tz);<br>  srandom(tv.tv_sec ^ tv.tv_usec ^ getpid());<br></code></pre></td></tr></table></figure>
<p>感觉是很常见的函数开头，之前读过的几个函数开始也有这几行—-打印版本信息、寻找路径信息、获取时间、获取随机数<br><strong>第一个while循环，进行参数读取</strong><br>随后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">setup_signal_handlers();<span class="hljs-comment">// 注册信号处理函数。</span><br>  check_asan_opts();<span class="hljs-comment">// 读取环境变量</span><br></code></pre></td></tr></table></figure>
<p><strong>setup_shm函数</strong><br>该函数用于设置共享内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">EXP_ST <span class="hljs-type">void</span> <span class="hljs-title function_">setup_shm</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br><br>  u8* shm_str;<br><br>  <span class="hljs-keyword">if</span> (!in_bitmap) <span class="hljs-built_in">memset</span>(virgin_bits, <span class="hljs-number">255</span>, MAP_SIZE);<br><br>  <span class="hljs-built_in">memset</span>(virgin_tmout, <span class="hljs-number">255</span>, MAP_SIZE);<span class="hljs-comment">//记录所有程序超时</span><br>  <span class="hljs-built_in">memset</span>(virgin_crash, <span class="hljs-number">255</span>, MAP_SIZE);<span class="hljs-comment">//记录所有程序崩溃</span><br><br>  shm_id = shmget(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | <span class="hljs-number">0600</span>);<br><br>  <span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>) PFATAL(<span class="hljs-string">&quot;shmget() failed&quot;</span>);<br><br>  atexit(remove_shm);<br><br>  shm_str = alloc_printf(<span class="hljs-string">&quot;%d&quot;</span>, shm_id);<br><br>  <span class="hljs-comment">/* If somebody is asking us to fuzz instrumented binaries in dumb mode,</span><br><span class="hljs-comment">     we don&#x27;t want them to detect instrumentation, since we won&#x27;t be sending</span><br><span class="hljs-comment">     fork server commands. This should be replaced with better auto-detection</span><br><span class="hljs-comment">     later on, perhaps? */</span><br><br>  <span class="hljs-keyword">if</span> (!dumb_mode) setenv(SHM_ENV_VAR, shm_str, <span class="hljs-number">1</span>);<br><br>  ck_free(shm_str);<br><br>  trace_bits = shmat(shm_id, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-keyword">if</span> (!trace_bits) PFATAL(<span class="hljs-string">&quot;shmat() failed&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中：<code>shmat</code>方法用于追踪当前的tuple信息，<code>trace_bits</code>位于共享内存上，用于传送信息。</p>
<p><strong>第一遍fuzz</strong></p>
<p><strong>calibrate_case函数</strong><br>是AFL的一个关键函数，用于新测试用例的校准，希望能早期发现有问题的测试用例。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> u8 <span class="hljs-title function_">calibrate_case</span><span class="hljs-params">(<span class="hljs-type">char</span>** argv, <span class="hljs-keyword">struct</span> queue_entry* q, u8* use_mem,</span><br><span class="hljs-params">                         u32 handicap, u8 from_queue)</span> &#123;<br><br>  <span class="hljs-type">static</span> u8 first_trace[MAP_SIZE];<br><br>  u8  fault = <span class="hljs-number">0</span>, new_bits = <span class="hljs-number">0</span>, var_detected = <span class="hljs-number">0</span>,<br>      first_run = (q-&gt;exec_cksum == <span class="hljs-number">0</span>);<br><br>  u64 start_us, stop_us;<br><br>  s32 old_sc = stage_cur, old_sm = stage_max;<br>  u32 use_tmout = exec_tmout;<br>  u8* old_sn = stage_name;<br><br>  <span class="hljs-comment">/* Be a bit more generous about timeouts when resuming sessions, or when</span><br><span class="hljs-comment">     trying to calibrate already-added finds. This helps avoid trouble due</span><br><span class="hljs-comment">     to intermittent latency. */</span><br><br>  <span class="hljs-keyword">if</span> (!from_queue || resuming_fuzz)<br>    use_tmout = MAX(exec_tmout + CAL_TMOUT_ADD,<br>                    exec_tmout * CAL_TMOUT_PERC / <span class="hljs-number">100</span>);<br><br>  q-&gt;cal_failed++;<br><br>  stage_name = <span class="hljs-string">&quot;calibration&quot;</span>;<br>  stage_max  = fast_cal ? <span class="hljs-number">3</span> : CAL_CYCLES;<br><br>  <span class="hljs-comment">/* Make sure the forkserver is up before we do anything, and let&#x27;s not</span><br><span class="hljs-comment">     count its spin-up time toward binary calibration. */</span><br><br>  <span class="hljs-keyword">if</span> (dumb_mode != <span class="hljs-number">1</span> &amp;&amp; !no_forkserver &amp;&amp; !forksrv_pid)<br>    init_forkserver(argv); <span class="hljs-comment">// 初始化启动forkserver</span><br><br>  <span class="hljs-keyword">if</span> (q-&gt;exec_cksum) <span class="hljs-built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);<br><br>  start_us = get_cur_time_us();<span class="hljs-comment">// </span><br><br>  <span class="hljs-keyword">for</span> (stage_cur = <span class="hljs-number">0</span>; stage_cur &lt; stage_max; stage_cur++) &#123;<span class="hljs-comment">// 该循环执行3或8次</span><br><br>    u32 cksum;<br><br>    <span class="hljs-keyword">if</span> (!first_run &amp;&amp; !(stage_cur % stats_update_freq)) show_stats();<br><br>    write_to_testcase(use_mem, q-&gt;len);<br><br>    fault = run_target(argv, use_tmout);<span class="hljs-comment">//run_target函数通知forkserver可以开始fork</span><br><br>    <span class="hljs-comment">/* stop_soon is set by the handler for Ctrl+C. When it&#x27;s pressed,</span><br><span class="hljs-comment">       we want to bail out quickly. */</span><br><br>    <span class="hljs-keyword">if</span> (stop_soon || fault != crash_mode) <span class="hljs-keyword">goto</span> abort_calibration;<br><br>    <span class="hljs-keyword">if</span> (!dumb_mode &amp;&amp; !stage_cur &amp;&amp; !count_bytes(trace_bits)) &#123;<br>      fault = FAULT_NOINST;<br>      <span class="hljs-keyword">goto</span> abort_calibration;<br>    &#125;<br><br>    cksum = hash32(trace_bits, MAP_SIZE, HASH_CONST);<span class="hljs-comment">//计算trace_bits的哈希值</span><br><br>    <span class="hljs-keyword">if</span> (q-&gt;exec_cksum != cksum) &#123;<span class="hljs-comment">//若哈希值不同</span><br><br>      u8 hnb = has_new_bits(virgin_bits);<br>      <span class="hljs-keyword">if</span> (hnb &gt; new_bits) new_bits = hnb;<span class="hljs-comment">//如果hnb＞new_bits，证明该new_bits已经跑过，将新的hnb赋值给new_bits,令其重新开始下一轮循环</span><br><br>      <span class="hljs-keyword">if</span> (q-&gt;exec_cksum) &#123;<span class="hljs-comment">// exec_cksum是循环次数，若不是第一次跑</span><br><br>        u32 i;<br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAP_SIZE; i++) &#123;<br><br>          <span class="hljs-keyword">if</span> (!var_bytes[i] &amp;&amp; first_trace[i] != trace_bits[i]) &#123;<br><br>            var_bytes[i] = <span class="hljs-number">1</span>;<br>            stage_max    = CAL_CYCLES_LONG;<br><br>          &#125;<br><br>        &#125;<br><br>        var_detected = <span class="hljs-number">1</span>;<br><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br><br>        q-&gt;exec_cksum = cksum;<br>        <span class="hljs-built_in">memcpy</span>(first_trace, trace_bits, MAP_SIZE);<br><br>      &#125;<br><br>    &#125;<br><br>  &#125;<br><br>  stop_us = get_cur_time_us();<br><br>  <br></code></pre></td></tr></table></figure>
<p><strong>init_forkserver函数</strong><br>该函数实现启动forkserver</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><code class="hljs c">EXP_ST <span class="hljs-type">void</span> <span class="hljs-title function_">init_forkserver</span><span class="hljs-params">(<span class="hljs-type">char</span>** argv)</span> &#123;<br><br>  <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">itimerval</span> <span class="hljs-title">it</span>;</span><br>  <span class="hljs-type">int</span> st_pipe[<span class="hljs-number">2</span>], ctl_pipe[<span class="hljs-number">2</span>];<span class="hljs-comment">//状态通道与控制通道</span><br>  <span class="hljs-type">int</span> status;<br>  s32 rlen;<br><br>  ACTF(<span class="hljs-string">&quot;Spinning up the fork server...&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (pipe(st_pipe) || pipe(ctl_pipe)) PFATAL(<span class="hljs-string">&quot;pipe() failed&quot;</span>);<span class="hljs-comment">//两个管道都建立失败，报错</span><br><br>  forksrv_pid = fork();<br><br>  <span class="hljs-keyword">if</span> (forksrv_pid &lt; <span class="hljs-number">0</span>) PFATAL(<span class="hljs-string">&quot;fork() failed&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (!forksrv_pid) &#123;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span>;</span><br><br>    <span class="hljs-comment">/* Umpf. On OpenBSD, the default fd limit for root users is set to</span><br><span class="hljs-comment">       soft 128. Let&#x27;s try to fix that... */</span><br><br>    <span class="hljs-keyword">if</span> (!getrlimit(RLIMIT_NOFILE, &amp;r) &amp;&amp; r.rlim_cur &lt; FORKSRV_FD + <span class="hljs-number">2</span>) &#123;<br><br>      r.rlim_cur = FORKSRV_FD + <span class="hljs-number">2</span>;<br>      setrlimit(RLIMIT_NOFILE, &amp;r); <span class="hljs-comment">/* Ignore errors */</span><br><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (mem_limit) &#123;<br><br>      r.rlim_max = r.rlim_cur = ((<span class="hljs-type">rlim_t</span>)mem_limit) &lt;&lt; <span class="hljs-number">20</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_AS</span><br><br>      setrlimit(RLIMIT_AS, &amp;r); <span class="hljs-comment">/* Ignore errors */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><br>      <span class="hljs-comment">/* This takes care of OpenBSD, which doesn&#x27;t have RLIMIT_AS, but</span><br><span class="hljs-comment">         according to reliable sources, RLIMIT_DATA covers anonymous</span><br><span class="hljs-comment">         maps - so we should be getting good protection against OOM bugs. */</span><br><br>      setrlimit(RLIMIT_DATA, &amp;r); <span class="hljs-comment">/* Ignore errors */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* ^RLIMIT_AS */</span></span><br><br><br>    &#125;<br><br>    <span class="hljs-comment">/* Dumping cores is slow and can lead to anomalies if SIGKILL is delivered</span><br><span class="hljs-comment">       before the dump is complete. */</span><br><br>    r.rlim_max = r.rlim_cur = <span class="hljs-number">0</span>;<br><br>    setrlimit(RLIMIT_CORE, &amp;r); <span class="hljs-comment">/* Ignore errors */</span><br><br>    <span class="hljs-comment">/* Isolate the process and configure standard descriptors. If out_file is</span><br><span class="hljs-comment">       specified, stdin is /dev/null; otherwise, out_fd is cloned instead. */</span><br><br>    setsid();<br><br>    dup2(dev_null_fd, <span class="hljs-number">1</span>);<br>    dup2(dev_null_fd, <span class="hljs-number">2</span>);<br><br>    <span class="hljs-keyword">if</span> (out_file) &#123;<br><br>      dup2(dev_null_fd, <span class="hljs-number">0</span>);<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br><br>      dup2(out_fd, <span class="hljs-number">0</span>);<br>      close(out_fd);<br><br>    &#125;<br><br>    <span class="hljs-comment">/* Set up control and status pipes, close the unneeded original fds. */</span><br><br>    <span class="hljs-keyword">if</span> (dup2(ctl_pipe[<span class="hljs-number">0</span>], FORKSRV_FD) &lt; <span class="hljs-number">0</span>) PFATAL(<span class="hljs-string">&quot;dup2() failed&quot;</span>);<br>    <span class="hljs-keyword">if</span> (dup2(st_pipe[<span class="hljs-number">1</span>], FORKSRV_FD + <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) PFATAL(<span class="hljs-string">&quot;dup2() failed&quot;</span>);<br><br>    close(ctl_pipe[<span class="hljs-number">0</span>]);<br>    close(ctl_pipe[<span class="hljs-number">1</span>]);<br>    close(st_pipe[<span class="hljs-number">0</span>]);<br>    close(st_pipe[<span class="hljs-number">1</span>]);<br><br>    close(out_dir_fd);<br>    close(dev_null_fd);<br>    close(dev_urandom_fd);<br>    close(fileno(plot_file));<br><br>    <span class="hljs-comment">/* This should improve performance a bit, since it stops the linker from</span><br><span class="hljs-comment">       doing extra work post-fork(). */</span><br><br>    <span class="hljs-keyword">if</span> (!getenv(<span class="hljs-string">&quot;LD_BIND_LAZY&quot;</span>)) setenv(<span class="hljs-string">&quot;LD_BIND_NOW&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* Set sane defaults for ASAN if nothing else specified. */</span><br><br>    setenv(<span class="hljs-string">&quot;ASAN_OPTIONS&quot;</span>, <span class="hljs-string">&quot;abort_on_error=1:&quot;</span><br>                           <span class="hljs-string">&quot;detect_leaks=0:&quot;</span><br>                           <span class="hljs-string">&quot;symbolize=0:&quot;</span><br>                           <span class="hljs-string">&quot;allocator_may_return_null=1&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* MSAN is tricky, because it doesn&#x27;t support abort_on_error=1 at this</span><br><span class="hljs-comment">       point. So, we do this in a very hacky way. */</span><br><br>    setenv(<span class="hljs-string">&quot;MSAN_OPTIONS&quot;</span>, <span class="hljs-string">&quot;exit_code=&quot;</span> STRINGIFY(MSAN_ERROR) <span class="hljs-string">&quot;:&quot;</span><br>                           <span class="hljs-string">&quot;symbolize=0:&quot;</span><br>                           <span class="hljs-string">&quot;abort_on_error=1:&quot;</span><br>                           <span class="hljs-string">&quot;allocator_may_return_null=1:&quot;</span><br>                           <span class="hljs-string">&quot;msan_track_origins=0&quot;</span>, <span class="hljs-number">0</span>);<br><br>    execv(target_path, argv);<br><br>    <span class="hljs-comment">/* Use a distinctive bitmap signature to tell the parent about execv()</span><br><span class="hljs-comment">       falling through. */</span><br><br>    *(u32*)trace_bits = EXEC_FAIL_SIG;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>  &#125;<br><br>  <span class="hljs-comment">/* Close the unneeded endpoints. */</span><br><br>  close(ctl_pipe[<span class="hljs-number">0</span>]);<br>  close(st_pipe[<span class="hljs-number">1</span>]);<br><br>  fsrv_ctl_fd = ctl_pipe[<span class="hljs-number">1</span>];<br>  fsrv_st_fd  = st_pipe[<span class="hljs-number">0</span>];<br><br>  <span class="hljs-comment">/* Wait for the fork server to come up, but don&#x27;t wait too long. */</span><br><br>  it.it_value.tv_sec = ((exec_tmout * FORK_WAIT_MULT) / <span class="hljs-number">1000</span>);<br>  it.it_value.tv_usec = ((exec_tmout * FORK_WAIT_MULT) % <span class="hljs-number">1000</span>) * <span class="hljs-number">1000</span>;<br><br>  setitimer(ITIMER_REAL, &amp;it, <span class="hljs-literal">NULL</span>);<br><br>  rlen = read(fsrv_st_fd, &amp;status, <span class="hljs-number">4</span>);<br><br>  it.it_value.tv_sec = <span class="hljs-number">0</span>;<br>  it.it_value.tv_usec = <span class="hljs-number">0</span>;<br><br>  setitimer(ITIMER_REAL, &amp;it, <span class="hljs-literal">NULL</span>);<br><br>  <span class="hljs-comment">/* If we have a four-byte &quot;hello&quot; message from the server, we&#x27;re all set.</span><br><span class="hljs-comment">     Otherwise, try to figure out what went wrong. */</span><br><br>  <span class="hljs-keyword">if</span> (rlen == <span class="hljs-number">4</span>) &#123;<br>    OKF(<span class="hljs-string">&quot;All right - fork server is up.&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (child_timed_out)<br>    FATAL(<span class="hljs-string">&quot;Timeout while initializing fork server (adjusting -t may help)&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (waitpid(forksrv_pid, &amp;status, <span class="hljs-number">0</span>) &lt;= <span class="hljs-number">0</span>)<br>    PFATAL(<span class="hljs-string">&quot;waitpid() failed&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (WIFSIGNALED(status)) &#123;<br><br>    <span class="hljs-keyword">if</span> (mem_limit &amp;&amp; mem_limit &lt; <span class="hljs-number">500</span> &amp;&amp; uses_asan) &#123;<br><br>      SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>           <span class="hljs-string">&quot;Whoops, the target binary crashed suddenly, before receiving any input\n&quot;</span><br>           <span class="hljs-string">&quot;    from the fuzzer! Since it seems to be built with ASAN and you have a\n&quot;</span><br>           <span class="hljs-string">&quot;    restrictive memory limit configured, this is expected; please read\n&quot;</span><br>           <span class="hljs-string">&quot;    %s/notes_for_asan.txt for help.\n&quot;</span>, doc_path);<br><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mem_limit) &#123;<br><br>      SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>           <span class="hljs-string">&quot;Whoops, the target binary crashed suddenly, before receiving any input\n&quot;</span><br>           <span class="hljs-string">&quot;    from the fuzzer! There are several probable explanations:\n\n&quot;</span><br><br>           <span class="hljs-string">&quot;    - The binary is just buggy and explodes entirely on its own. If so, you\n&quot;</span><br>           <span class="hljs-string">&quot;      need to fix the underlying problem or find a better replacement.\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __APPLE__</span><br><br>           <span class="hljs-string">&quot;    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n&quot;</span><br>           <span class="hljs-string">&quot;      break afl-fuzz performance optimizations when running platform-specific\n&quot;</span><br>           <span class="hljs-string">&quot;      targets. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* __APPLE__ */</span></span><br><br>           <span class="hljs-string">&quot;    - Less likely, there is a horrible bug in the fuzzer. If other options\n&quot;</span><br>           <span class="hljs-string">&quot;      fail, poke &lt;lcamtuf@coredump.cx&gt; for troubleshooting tips.\n&quot;</span>);<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br><br>      SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>           <span class="hljs-string">&quot;Whoops, the target binary crashed suddenly, before receiving any input\n&quot;</span><br>           <span class="hljs-string">&quot;    from the fuzzer! There are several probable explanations:\n\n&quot;</span><br><br>           <span class="hljs-string">&quot;    - The current memory limit (%s) is too restrictive, causing the\n&quot;</span><br>           <span class="hljs-string">&quot;      target to hit an OOM condition in the dynamic linker. Try bumping up\n&quot;</span><br>           <span class="hljs-string">&quot;      the limit with the -m setting in the command line. A simple way confirm\n&quot;</span><br>           <span class="hljs-string">&quot;      this diagnosis would be:\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_AS</span><br>           <span class="hljs-string">&quot;      ( ulimit -Sv $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>           <span class="hljs-string">&quot;      ( ulimit -Sd $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* ^RLIMIT_AS */</span></span><br><br>           <span class="hljs-string">&quot;      Tip: you can use http://jwilk.net/software/recidivm to quickly\n&quot;</span><br>           <span class="hljs-string">&quot;      estimate the required amount of virtual memory for the binary.\n\n&quot;</span><br><br>           <span class="hljs-string">&quot;    - The binary is just buggy and explodes entirely on its own. If so, you\n&quot;</span><br>           <span class="hljs-string">&quot;      need to fix the underlying problem or find a better replacement.\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __APPLE__</span><br><br>           <span class="hljs-string">&quot;    - On MacOS X, the semantics of fork() syscalls are non-standard and may\n&quot;</span><br>           <span class="hljs-string">&quot;      break afl-fuzz performance optimizations when running platform-specific\n&quot;</span><br>           <span class="hljs-string">&quot;      targets. To fix this, set AFL_NO_FORKSRV=1 in the environment.\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* __APPLE__ */</span></span><br><br>           <span class="hljs-string">&quot;    - Less likely, there is a horrible bug in the fuzzer. If other options\n&quot;</span><br>           <span class="hljs-string">&quot;      fail, poke &lt;lcamtuf@coredump.cx&gt; for troubleshooting tips.\n&quot;</span>,<br>           DMS(mem_limit &lt;&lt; <span class="hljs-number">20</span>), mem_limit - <span class="hljs-number">1</span>);<br><br>    &#125;<br><br>    FATAL(<span class="hljs-string">&quot;Fork server crashed with signal %d&quot;</span>, WTERMSIG(status));<br><br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (*(u32*)trace_bits == EXEC_FAIL_SIG)<br>    FATAL(<span class="hljs-string">&quot;Unable to execute target application (&#x27;%s&#x27;)&quot;</span>, argv[<span class="hljs-number">0</span>]);<br><br>  <span class="hljs-keyword">if</span> (mem_limit &amp;&amp; mem_limit &lt; <span class="hljs-number">500</span> &amp;&amp; uses_asan) &#123;<br><br>    SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>           <span class="hljs-string">&quot;Hmm, looks like the target binary terminated before we could complete a\n&quot;</span><br>           <span class="hljs-string">&quot;    handshake with the injected code. Since it seems to be built with ASAN and\n&quot;</span><br>           <span class="hljs-string">&quot;    you have a restrictive memory limit configured, this is expected; please\n&quot;</span><br>           <span class="hljs-string">&quot;    read %s/notes_for_asan.txt for help.\n&quot;</span>, doc_path);<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mem_limit) &#123;<br><br>    SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>         <span class="hljs-string">&quot;Hmm, looks like the target binary terminated before we could complete a\n&quot;</span><br>         <span class="hljs-string">&quot;    handshake with the injected code. Perhaps there is a horrible bug in the\n&quot;</span><br>         <span class="hljs-string">&quot;    fuzzer. Poke &lt;lcamtuf@coredump.cx&gt; for troubleshooting tips.\n&quot;</span>);<br><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br><br>    SAYF(<span class="hljs-string">&quot;\n&quot;</span> cLRD <span class="hljs-string">&quot;[-] &quot;</span> cRST<br>         <span class="hljs-string">&quot;Hmm, looks like the target binary terminated before we could complete a\n&quot;</span><br>         <span class="hljs-string">&quot;    handshake with the injected code. There are %s probable explanations:\n\n&quot;</span><br><br>         <span class="hljs-string">&quot;%s&quot;</span><br>         <span class="hljs-string">&quot;    - The current memory limit (%s) is too restrictive, causing an OOM\n&quot;</span><br>         <span class="hljs-string">&quot;      fault in the dynamic linker. This can be fixed with the -m option. A\n&quot;</span><br>         <span class="hljs-string">&quot;      simple way to confirm the diagnosis may be:\n\n&quot;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RLIMIT_AS</span><br>         <span class="hljs-string">&quot;      ( ulimit -Sv $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>         <span class="hljs-string">&quot;      ( ulimit -Sd $[%llu &lt;&lt; 10]; /path/to/fuzzed_app )\n\n&quot;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* ^RLIMIT_AS */</span></span><br><br>         <span class="hljs-string">&quot;      Tip: you can use http://jwilk.net/software/recidivm to quickly\n&quot;</span><br>         <span class="hljs-string">&quot;      estimate the required amount of virtual memory for the binary.\n\n&quot;</span><br><br>         <span class="hljs-string">&quot;    - Less likely, there is a horrible bug in the fuzzer. If other options\n&quot;</span><br>         <span class="hljs-string">&quot;      fail, poke &lt;lcamtuf@coredump.cx&gt; for troubleshooting tips.\n&quot;</span>,<br>         getenv(DEFER_ENV_VAR) ? <span class="hljs-string">&quot;three&quot;</span> : <span class="hljs-string">&quot;two&quot;</span>,<br>         getenv(DEFER_ENV_VAR) ?<br>         <span class="hljs-string">&quot;    - You are using deferred forkserver, but __AFL_INIT() is never\n&quot;</span><br>         <span class="hljs-string">&quot;      reached before the program terminates.\n\n&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>         DMS(mem_limit &lt;&lt; <span class="hljs-number">20</span>), mem_limit - <span class="hljs-number">1</span>);<br><br>  &#125;<br><br>  FATAL(<span class="hljs-string">&quot;Fork server handshake failed&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>perform_dry_run函数</strong></p>
<p>遍历<code>input</code>队列，读取文件内容，调用<code>calibrate_case</code>进行校准，收集错误信息<br><strong>run_target函数</strong><br>执行目标程序，传回状态信息。<br><strong>cull_queue函数</strong><br>通过遍历top_rated[]条目，获取“获胜者”，这些获胜者会获得更多执行时间。优化作用。<br>等等，还要许多配置函数，为环境的顺利做准备。<br><strong>主循环</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>    u8 skipped_fuzz;<br><br>    cull_queue();<br><br>    <span class="hljs-keyword">if</span> (!queue_cur) &#123;<span class="hljs-comment">//如果queue当前为空，即执行完一轮</span><br><br>      queue_cycle++;<br>      current_entry     = <span class="hljs-number">0</span>;<br>      cur_skipped_paths = <span class="hljs-number">0</span>;<br>      queue_cur         = <span class="hljs-built_in">queue</span>;<span class="hljs-comment">//准备下一轮</span><br><br>      <span class="hljs-keyword">while</span> (seek_to) &#123;<span class="hljs-comment">//从seek_to指定项开始执行。</span><br>        current_entry++;<br>        seek_to--;<br>        queue_cur = queue_cur-&gt;next;<br>      &#125;<br><br>      show_stats();<br><br>      <span class="hljs-keyword">if</span> (not_on_tty) &#123;<br>        ACTF(<span class="hljs-string">&quot;Entering queue cycle %llu.&quot;</span>, queue_cycle);<br>        fflush(<span class="hljs-built_in">stdout</span>);<br>      &#125;<br><br>      <span class="hljs-comment">/* If we had a full queue cycle with no new finds, try</span><br><span class="hljs-comment">         recombination strategies next. */</span><br><br>      <span class="hljs-keyword">if</span> (queued_paths == prev_queued) &#123;<span class="hljs-comment">//如果path数没变，即没有新发现</span><br><br>        <span class="hljs-keyword">if</span> (use_splicing) cycles_wo_finds++; <span class="hljs-keyword">else</span> use_splicing = <span class="hljs-number">1</span>;<span class="hljs-comment">//是否使用splicing策略</span><br><br>      &#125; <span class="hljs-keyword">else</span> cycles_wo_finds = <span class="hljs-number">0</span>;<br><br>      prev_queued = queued_paths;<span class="hljs-comment">//更新路径数</span><br><br>      <span class="hljs-keyword">if</span> (sync_id &amp;&amp; queue_cycle == <span class="hljs-number">1</span> &amp;&amp; getenv(<span class="hljs-string">&quot;AFL_IMPORT_FIRST&quot;</span>))<br>        sync_fuzzers(use_argv);<br><br>    &#125;<br><br>    skipped_fuzz = fuzz_one(use_argv);<span class="hljs-comment">//关键函数fuzz_one</span><br><br>    <span class="hljs-keyword">if</span> (!stop_soon &amp;&amp; sync_id &amp;&amp; !skipped_fuzz) &#123;<br>      <br>      <span class="hljs-keyword">if</span> (!(sync_interval_cnt++ % SYNC_INTERVAL))<br>        sync_fuzzers(use_argv);<br><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!stop_soon &amp;&amp; exit_1) stop_soon = <span class="hljs-number">2</span>;<br><br>    <span class="hljs-keyword">if</span> (stop_soon) <span class="hljs-keyword">break</span>;<br><br>    queue_cur = queue_cur-&gt;next;<br>    current_entry++;<br><br>  &#125;<br></code></pre></td></tr></table></figure>
<p><strong>关键函数fuzz_one()</strong></p>
<ul>
<li>先进行优化：概率跳过普通执行项或已执行项，去执行favored</li>
<li>对于已经fuzz过的或者non-favored的有99%的概率跳过；无pending_favored，95%跳过fuzzed&amp;non-favored，75%跳过not fuzzed&amp;non-favored，不跳过favored；</li>
<li>打开当前输入文件，读入len长度的buf，关闭文件</li>
<li>（当之前修理失败时）再次调用<code>celibrate_case</code>，</li>
<li>修剪：不要重复修剪，哪怕修建失败了</li>
<li>将读入的buf复制到out_buf</li>
<li>进行打分，对每个测试用例</li>
<li>如果我们已经亲自对这里的测试用例进行了fuzzing或早些时候，进行了决定性的测试，跳过这里直接前往<code>havoc_stage</code></li>
</ul>
<p><strong>简单位翻转bitflip</strong></p>
<h2 id="afl-llvm-mode"><a href="#afl-llvm-mode" class="headerlink" title="afl-llvm_mode"></a>afl-llvm_mode</h2><p><strong>关于LLVM</strong></p>
<ul>
<li>LLVM 主要为了解决编译时多种多样的前端和后端导致编译环境复杂、苛刻的问题，其核心为设计了一个称为<code> LLVM IR</code> 的中间表示，并以库的形式提供一些列接口，以提供诸如操作 IR 、生成目标平台代码等等后端的功能。</li>
<li>不同的前端和后端使用统一的中间代码<code>LLVM InterMediate Representation(LLVM IR)</code>，其结果就是如果需要支持一门新的编程语言，只需要实现一个新的前端；如果需要支持一款新的硬件设备，只需要实现一个新的后端；优化阶段为通用阶段，针对统一的 LLVM IR ，与新的编程语言和硬件设备无关。</li>
<li>GCC 的前后端耦合在一起，没有进行分离，所以GCC为了支持一门新的编程语言或一个新的硬件设备，需要重新开发前端到后端的完整过程。</li>
<li>Clang 是 LLVM 项目的一个子项目，它是 LLVM 架构下的 C/C++/Objective-C 的编译器，是 LLVM 前端的一部分。相较于GCC，具备编译速度快、占用内存少、模块化设计、诊断信息可读性强、设计清晰简单等优点。</li>
<li>代码首先由编译器前端clang处理后得到中间代码IR，然后经过各 LLVM Pass 进行优化和转换，最终交给编译器后端生成机器码（<strong>LLVM Pass 是一些中间过程处理 IR 的可以用户自定义的内容，可以用来遍历、修改 IR 以达到插桩、优化、静态分析等目的。</strong>）</li>
</ul>
<p><strong>afl-clang-fast</strong><br>1.概述<br>AFL的 llvm_mode 可以实现编译器级别的插桩，可以替代 afl-gcc 或 afl-clang 使用的比较“粗暴”的汇编级别的重写的方法，且具备如下几个优势：</p>
<ul>
<li>编译器可以进行优化以提升效率；</li>
<li>实现与CPU无关，可以在非x86架构上进行fuzz；</li>
<li>可以更好处理多线程目标程序。</li>
</ul>
<p>关于此<code>llvm_mode</code>文件夹：</p>
<ul>
<li><code>afl-llvm-rt.o</code>重写了<code>afl-as.h</code>中的main_payload，用于调用；</li>
<li><code>afl-llvm-pass.so.cc</code>文件主要是当通过 afl-clang-fast 调用 clang 时，这个pass被插入到 LLVM 中，告诉编译器添加与 <code>afl-as.h</code> 中大致等效的代码；</li>
<li><code>afl-clang-fast.c</code> 文件本质上是 clang 的 wrapper，最终调用的还是 clang 。但是与 afl-gcc 一样，会进行一些参数处理。</li>
</ul>
<p><strong><code>llvm_mode</code> 的插桩思路就是通过编写pass来实现信息记录，对每个基本块都插入探针，具体代码在 <code>afl-llvm-pass.so.cc</code> 文件中，初始化和forkserver操作通过链接完成。</strong></p>
<p><strong>源码分析</strong></p>
<p><strong>find_pbj</strong><br>寻找运行时的<code>librabies</code>，若失败，abort。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">find_obj</span><span class="hljs-params">(u8* argv0)</span> &#123;<br><br>  u8 *afl_path = getenv(<span class="hljs-string">&quot;AFL_PATH&quot;</span>);<span class="hljs-comment">//寻找AFL_PATH</span><br>  u8 *slash, *tmp;<br><br>  <span class="hljs-keyword">if</span> (afl_path) &#123;<br><br>    tmp = alloc_printf(<span class="hljs-string">&quot;%s/afl-llvm-rt.o&quot;</span>, afl_path);<span class="hljs-comment">//将afl-llvm-rt.o的路径写入tmp</span><br><br>    <span class="hljs-keyword">if</span> (!access(tmp, R_OK)) &#123;<span class="hljs-comment">//如果该路径可以访问，且可读</span><br>      obj_path = afl_path;<span class="hljs-comment">//赋值给obj_path</span><br>      ck_free(tmp);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ck_free(tmp);<br><br>  &#125;<br><br>  slash = <span class="hljs-built_in">strrchr</span>(argv0, <span class="hljs-string">&#x27;/&#x27;</span>);<span class="hljs-comment">//返回斜杠最后一次出现处的指针</span><br><br>  <span class="hljs-keyword">if</span> (slash) &#123;<span class="hljs-comment">//存在斜杠</span><br><br>    u8 *dir;<br><br>    *slash = <span class="hljs-number">0</span>;<br>    dir = ck_strdup(argv0);<br>    *slash = <span class="hljs-string">&#x27;/&#x27;</span>;<br><br>    tmp = alloc_printf(<span class="hljs-string">&quot;%s/afl-llvm-rt.o&quot;</span>, dir);<br><br>    <span class="hljs-keyword">if</span> (!access(tmp, R_OK)) &#123;<br>      obj_path = dir;<br>      ck_free(tmp);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ck_free(tmp);<br>    ck_free(dir);<br><br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!access(AFL_PATH <span class="hljs-string">&quot;/afl-llvm-rt.o&quot;</span>, R_OK)) &#123;<br>    obj_path = AFL_PATH;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  FATAL(<span class="hljs-string">&quot;Unable to find &#x27;afl-llvm-rt.o&#x27; or &#x27;afl-llvm-pass.so&#x27;. Please set AFL_PATH&quot;</span>);<br> <br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>首先，读取环境变量 AFL_PATH 的值：<ul>
<li>如果读取成功，确认 <code>AFL_PATH/afl-llvm-rt.o</code> 是否可以访问；如果可以访问，设置该目录为 <code>obj_path</code> ，然后直接返回；</li>
<li>如果读取失败，检查 <code>arg0</code> 中是否存在<code> /</code> 字符，如果存在，则判断最后一个 <code>/ </code>前面的路径为 AFL 的根目录；然后读取<code>afl-llvm-rt.o</code>文件，成功读取，设置该目录为<code> obj_path</code> ，然后直接返回。</li>
</ul>
</li>
<li>如果上面两种方式都失败，到<code>/usr/local/lib/afl</code> 目录下查找是否存在 <code>afl-llvm-rt.o</code> ，如果存在，则设置为 <code>obj_path</code> 并直接返回（之所以向该路径下寻找，是因为<strong>默认的AFL的MakeFile在编译时，会定义一个名为<code>AFL_PATH</code>的宏，该宏会指向该路径</strong>）；</li>
</ul>
<p><strong>总而言之，该函数是为了寻找<code>afl-llvm-rt.o</code>文件，该文件即为要用到的运行时库。</strong></p>
<p><strong>edit_params函数</strong><br>即编辑对应参数</p>
<p><strong>2.afl-llvm-pass.so.cc</strong></p>
<figure class="highlight plaintext"><figcaption><span>文件实现了 LLVM-mode 下的一个插桩 LLVM Pass。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs afl-llvm-pass.so.cc```">该文件只有一个Transform pass：```AFLCoverage```，继承自 ```ModulePass```，实现了一个``` runOnModule``` 函数，这也是我们需要重点分析的函数。<br>```c<br>namespace &#123;<br><br>  class AFLCoverage : public ModulePass &#123;<br><br>    public:<br><br>      static char ID;<br>      AFLCoverage() : ModulePass(ID) &#123; &#125;<br><br>      bool runOnModule(Module &amp;M) override;<br><br>      // StringRef getPassName() const override &#123;<br>      //  return &quot;American Fuzzy Lop Instrumentation&quot;;<br>      // &#125;<br><br>  &#125;;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p><strong>runOnModule函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">LLVMContext &amp;C = M.getContext();<br></code></pre></td></tr></table></figure>
<p>获取上下文；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Decide instrumentation ratio */</span><br><span class="hljs-type">char</span>* inst_ratio_str = getenv(<span class="hljs-string">&quot;AFL_INST_RATIO&quot;</span>);<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inst_ratio = <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure>
<p>设置插桩密度，默认为100</p>
<p>获取指向共享内存shm的指针和上一个基本块的id</p>
<p>开始插桩：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> inst_blocks = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;F : M)<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> &amp;BB : F) &#123;<span class="hljs-comment">// 遍历每一个BB（基本块）</span><br><br>      BasicBlock::iterator IP = BB.getFirstInsertionPt();<span class="hljs-comment">//寻找BB中合适位置</span><br>      IRBuilder&lt;&gt; IRB(&amp;(*IP));<span class="hljs-comment">//初始化IRBuider实例执行插入</span><br><br>      <span class="hljs-keyword">if</span> (AFL_R(<span class="hljs-number">100</span>) &gt;= inst_ratio) <span class="hljs-keyword">continue</span>;<span class="hljs-comment">//如果大于插桩密度</span><br><br>      <span class="hljs-comment">/* Make up cur_loc */</span><br><br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cur_loc = AFL_R(MAP_SIZE);<span class="hljs-comment">//随机创建当前基本块ID</span><br><br>      ConstantInt *CurLoc = ConstantInt::get(Int32Ty, cur_loc);<br><br>      <span class="hljs-comment">/* Load prev_loc */</span><br><br>      LoadInst *PrevLoc = IRB.CreateLoad(AFLPrevLoc);<br>      PrevLoc-&gt;setMetadata(M.getMDKindID(<span class="hljs-string">&quot;nosanitize&quot;</span>), MDNode::get(C, None));<br>      Value *PrevLocCasted = IRB.CreateZExt(PrevLoc, IRB.getInt32Ty());<br>      <span class="hljs-comment">//获取上一个BB的ID</span><br><br>      <span class="hljs-comment">/* Load SHM pointer */</span><br><br>      LoadInst *MapPtr = IRB.CreateLoad(AFLMapPtr);<span class="hljs-comment">//获取SHM地址</span><br>      MapPtr-&gt;setMetadata(M.getMDKindID(<span class="hljs-string">&quot;nosanitize&quot;</span>), MDNode::get(C, None));<br>      Value *MapPtrIdx =<br>          IRB.CreateGEP(MapPtr, IRB.CreateXor(PrevLocCasted, CurLoc));<br><br>      <span class="hljs-comment">/* Update bitmap */</span><br>      <span class="hljs-comment">//更新共享内存</span><br>      LoadInst *Counter = IRB.CreateLoad(MapPtrIdx);<br>      Counter-&gt;setMetadata(M.getMDKindID(<span class="hljs-string">&quot;nosanitize&quot;</span>), MDNode::get(C, None));<br>      Value *Incr = IRB.CreateAdd(Counter, ConstantInt::get(Int8Ty, <span class="hljs-number">1</span>));<br>      IRB.CreateStore(Incr, MapPtrIdx)<br>          -&gt;setMetadata(M.getMDKindID(<span class="hljs-string">&quot;nosanitize&quot;</span>), MDNode::get(C, None));<br><br>      <span class="hljs-comment">/* Set prev_loc to cur_loc &gt;&gt; 1 */</span><br><br>      StoreInst *Store =<br>          IRB.CreateStore(ConstantInt::get(Int32Ty, cur_loc &gt;&gt; <span class="hljs-number">1</span>), AFLPrevLoc);<br>      Store-&gt;setMetadata(M.getMDKindID(<span class="hljs-string">&quot;nosanitize&quot;</span>), MDNode::get(C, None));<br><br>      inst_blocks++;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<p><strong>3. afl-llvm-rt.o.c</strong><br>该文件主要实现了llvm_mode的3个特殊功能：<code>deferred instrumentation, persistent mode,trace-pc-guard mode</code></p>
<p><strong>deferred instrumentation</strong>:<br>AFL会尝试通过只执行一次目标二进制文件来提升性能，在<code> main()</code> 之前暂停程序，然后克隆“主”进程获得一个稳定的可进行持续fuzz的目标。简言之，避免目标二进制文件的多次、重复的完整运行，而是采取了一种类似快照的机制。</p>
<p>虽然这种机制可以减少程序运行在操作系统、链接器和libc级别的消耗，但是在面对大型配置文件的解析时，优势并不明显。</p>
<p>在这种情况下，可以将 <code>forkserver</code> 的<strong>初始化放在大部分初始化工作完成之后、二进制文件解析之前</strong>来进行，这在某些情况下可以提升10倍以上的性能。我们把这种方式称为LLVM模式下的 <code>deferred instrumentation</code>。</p>
<p>首先，在代码中寻找可以进行延迟克隆的合适的、不会破坏原二进制文件的位置，然后添加如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __AFL_HAVE_MANUAL_CONTROL    __AFL_INIT();#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>
<p><strong>persistent mode</strong></p>
<figure class="highlight plaintext"><figcaption><span>mode``` 并没有通过```fork```子进程的方式来执行fuzz。一些库中提供的API是无状态的，或者可以在处理不同输入文件之间进行重置，恢复到之前的状态。执行此类重置时，可以使用一个长期存活的进程来测试多个用例，以这种方式来减少重复的 ```fork()``` 调用和操作系统的开销。不得不说，这种思路真的很优秀。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs persistent"><br>设计框架如下：<br>设置一个 while 循环，并指定循环次数。在每次循环内，首先读取数据，然后调用想fuzz的库代码，然后重置状态，继续循环。（本质上也是一种快照。）<br><br>对于循环次数的设置，循环次数控制了AFL从头重新启动过程之前的最大迭代次数，较小的循环次数可以降低内存泄漏类故障的影响，官方建议的数值为1000。（循环次数设置过高可能出现较多意料之外的问题，并不建议设置过高。）<br>```c<br>while (__AFL_LOOP(1000)) &#123;  /* Read input data. */  /* Call library code to be fuzzed. */  /* Reset state. */&#125;/* Exit normally */<br></code></pre></td></tr></table></figure>
<p><strong>trace-pc-guard mode</strong><br>该功能的使用需要设置宏 <code>AFL_TRACE_PC=1 </code>，然后再执行 <code>afl-clang-fast </code>时传入参数<code>-fsanitize-coverage=trace-pc-guard</code>。</p>
<p>该功能的主要特点是会在每个edge插入桩代码，函数<code>__sanitizer_cov_trace_pc_guard</code>会在每个edge进行调用，该函数利用函数参数 <code>guard </code>指针所指向的 <code>uint32</code> 值来确定共享内存上所对应的地址</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/27/come-back/">
                        <span class="hidden-mobile">come back</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     fc love 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
